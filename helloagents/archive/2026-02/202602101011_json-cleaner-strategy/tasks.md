# 任务清单: json-cleaner-strategy

> **@status:** completed | 2026-02-10 11:12

目录: `helloagents/plan/202602101011_json-cleaner-strategy/`

---

## 任务状态符号说明

| 符号 | 状态 | 说明 |
|------|------|------|
| `[ ]` | pending | 待执行 |
| `[√]` | completed | 已完成 |
| `[X]` | failed | 执行失败 |
| `[-]` | skipped | 已跳过 |
| `[?]` | uncertain | 待确认 |

---

## 执行状态
```yaml
总任务: 28
已完成: 28
完成率: 100%
```

---

## 任务列表

### 0. 需求边界与规则语法确认

- [√] 0.1 确认首版规则语法使用 JSONPath（`jsonpath-plus`）
  - 验证: 文档与代码注释统一标注 JSONPath 作为唯一规则语法

- [√] 0.2 确认首版策略存储介质为 `localStorage`，并定义数据版本字段
  - 验证: 存储数据结构含 `version`，读取流程可处理空存储

- [√] 0.3 明确删除根节点规则（`$`）的禁止策略
  - 验证: 对 `$` 规则给出可读错误提示且不执行删除

### 1. 清理核心能力（utils/json-cleaner.ts）

- [√] 1.1 新增 `utils/json-cleaner.ts`，定义策略与结果类型
  - 验证: 类型可在组件与测试中直接导入

- [√] 1.2 实现 `validateStrategy`：规则去空、去重、基础合法性校验
  - 依赖: 1.1
  - 验证: 空规则与非法规则返回结构化错误信息

- [√] 1.3 实现 `applyJsonCleanStrategy`：逐条 JSONPath 执行删除并统计结果
  - 依赖: 1.1, 1.2
  - 验证: 返回 `cleaned + summary + details`，统计值可预测
  - 注意: 数组元素按索引从大到小删除；重复命中节点仅删除一次并记日志

- [√] 1.4 增加输入解析与错误处理（非法 JSON、空输入）
  - 依赖: 1.3
  - 验证: 错误路径不抛未捕获异常，UI 可直接展示错误文案

### 2. 策略持久化能力（utils/json-clean-strategy-store.ts）

- [√] 2.1 新增 `utils/json-clean-strategy-store.ts`，实现列表读取与写入
  - 验证: 新增策略后刷新页面可再次读取

- [√] 2.2 实现 `upsert/delete/getById` 能力，封装统一存储键名
  - 依赖: 2.1
  - 验证: 编辑覆盖与删除行为正确，列表顺序稳定

- [√] 2.2a 实现策略名称唯一性校验（重名时提示重命名）
  - 依赖: 2.2
  - 验证: 保存同名策略时返回可读错误信息

- [√] 2.3 增加存储数据版本兼容处理（version 不匹配降级策略）
  - 依赖: 2.1
  - 验证: 老数据可被安全忽略或迁移，不影响页面使用

### 3. 工具页面实现（components/JsonCleaner.tsx）

- [√] 3.1 新增 `components/JsonCleaner.tsx` 页面骨架（ToolHeader + ToolMain）
  - 验证: 页面可渲染输入区、策略区、输出区基础结构

- [√] 3.2 实现 Header Actions（执行清理 / 复制 / 下载 / 清空）
  - 依赖: 3.1
  - 验证: 各按钮显示正确并完成事件绑定

- [√] 3.3 实现 Toolbar（策略选择 + 规则快捷编辑 + 结果统计入口）
  - 依赖: 2.1, 2.2, 3.1
  - 验证: 可选择策略并编辑规则，统计入口可展示摘要

- [√] 3.4 实现主区响应式布局（桌面双列、窄屏单列）
  - 依赖: 3.1
  - 验证: 不同宽度下布局切换正确，区域可独立滚动

- [√] 3.5 绑定核心交互（输入 JSON → 执行清理 → 输出结果）
  - 依赖: 1.3, 1.4, 3.2, 3.3, 3.4
  - 验证: 清理结果 JSON 与 summary 正确联动展示

- [√] 3.6 实现策略管理交互（新建/加载/保存/重命名/删除）
  - 依赖: 2.2, 2.2a, 3.3
  - 验证: 策略 CRUD 与存储一致

- [√] 3.7 实现错误态与空态展示（非法 JSON、非法规则、无匹配、空策略）
  - 依赖: 1.4, 3.5, 3.6
  - 验证: 各异常场景均有明确提示且不阻断页面使用

- [√] 3.8 完善结果操作（复制、下载、清空）可用性与提示反馈
  - 依赖: 3.2, 3.5
  - 验证: 下载内容与输出一致，复制后出现成功提示

### 4. 工具接入（路由与注册）

- [√] 4.1 修改 `utils/tool-modules.ts`：新增 `json-cleaner` ToolId 与展示元信息
  - 验证: 侧边栏与 popup 列表可见“JSON 清理”

- [√] 4.2 修改 `entrypoints/tools.html/App.tsx`：注册 `JsonCleaner` 组件路由
  - 依赖: 3.1, 4.1
  - 验证: 访问 `#/json-cleaner` 可进入页面

### 5. 测试与验证

- [√] 5.1 新增 `tests/json-cleaner.test.js`：覆盖正常清理场景
  - 依赖: 1.3
  - 验证: 给定样例 JSON 可删除指定嵌套字段并输出预期结果

- [√] 5.2 补充边界/异常场景测试（无匹配规则、非法 JSONPath、非法 JSON）
  - 依赖: 5.1
  - 验证: 错误信息稳定可断言，未出现崩溃

- [√] 5.2a 补充数组删除顺序与深层嵌套路径测试
  - 依赖: 5.1
  - 验证: 多索引删除后结果正确，无索引偏移误删

- [√] 5.3 更新 `tests/tool-modules.test.js`：新增 `json-cleaner` 注册断言
  - 依赖: 4.1
  - 验证: 工具注册回归测试通过

- [√] 5.4 执行回归检查（`npm run compile` + `node --test tests/*.test.js`）
  - 依赖: 4.2, 5.2, 5.3
  - 验证: 编译通过，既有测试无回归

### 6. 知识库与变更记录同步（开发实施完成后执行）

- [√] 6.1 更新 `helloagents/modules/_index.md` 与相关模块文档（新增 JSON 清理工具说明）
  - 依赖: 5.4
  - 验证: 模块索引可导航，文档描述与代码一致

- [√] 6.2 更新 `helloagents/CHANGELOG.md` 记录本次新增功能
  - 依赖: 5.4
  - 验证: 记录格式符合项目 CHANGELOG 规范

---

## 执行备注

> 执行过程中的重要记录

| 任务 | 状态 | 备注 |
|------|------|------|
| 方案包创建 | `[√]` | 已创建 `202602101011_json-cleaner-strategy` |
| 需求评估 | `[√]` | 评分 8/10，判定为轻量迭代并进入 ~plan |
| 多模型审查 | `[√]` | 已执行 Claude/Gemini 审查（SESSION_ID: `0f5252f4-e1e6-40cb-a514-9794e57c4abd` / `83c39c37-5099-4bdb-aba6-c190ff36f3dd`） |
| 编译验证 | `[√]` | `npm run compile` 通过 |
| 测试验证 | `[√]` | `node --test tests/*.test.js` 通过（105/105） |
| 完成后一致性验证 | `[√]` | Claude(`58f7d0cc-6e31-4c2c-99c7-27fa730dbb18`) + Gemini(`c2459542-ac94-40b7-a313-3377652acb79`) 复核完成，未发现需落地补丁 |
